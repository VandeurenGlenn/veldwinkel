import{I as e}from"./image-mixin-bc9c72cf.js";customElements.define("shop-admin-action-bar",class ShopAdminActionBar extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=this.template}get template(){return'<style>\n      :host {\n        display: flex;\n        flex-direction: row;\n        height: 72px;\n        box-sizing: border-box;\n        padding: 24px;\n        width: 100%;\n        max-width: 640px;\n      }\n      .flex {\n        flex: 1;\n      }\n    </style>\n    \n    <custom-svg-icon icon="delete"></custom-svg-icon>\n    <span class="flex"></span>\n    <custom-svg-icon icon="public"></custom-svg-icon>\n    '}});class ProductEditorMixin extends(e(ElementBase)){get actionBar(){return this.shadowRoot.querySelector("shop-admin-action-bar")}get publicIcon(){return this.actionBar.shadowRoot.querySelector('[icon="public"]')}get deleteButton(){return this.actionBar.shadowRoot.querySelector('[icon="delete"]')}get saveButton(){return this.actionBar.shadowRoot.querySelector('[icon="save"]')}get nails(){return this.shadowRoot.querySelector("image-nails")}set value(e){this._value=e,this.rendered&&this.stamp()}isOnline(){return navigator.onLine}constructor(e="products"){super(),this._onNailUpload=this._onNailUpload.bind(this),this._onDelete=this._onDelete.bind(this),this._onPublic=this._onPublic.bind(this),this._onImageSwiped=this._onImageSwiped.bind(this),this.runJobQue=this.runJobQue.bind(this),this.ref=e,this.jobs=[],window.addEventListener("online",this.runJobQue,!1)}connectedCallback(){super.connectedCallback&&super.connectedCallback(),this._value&&this.stamp(),this.nails.addEventListener("nail-upload",this._onNailUpload),this.nails.addEventListener("image-swiped",this._onImageSwiped),this.publicIcon.addEventListener("click",this._onPublic),this.deleteButton.addEventListener("click",this._onDelete)}async runJobQue(){if(this.jobs.length>0&&this.isOnline()){const[e,t,i]=this.jobs.shift();await fetch(e,t),new Notification(i+" updated in background",{tag:"updated in background"})}this.jobs.length>0&&this.isOnline()&&this.runJobQue()}async _onImageSwiped({detail:e}){this.saving=!0;const t=e.getAttribute("key");let i=Array.from(this.nails.querySelectorAll("img"));if(0===i.length||1===i.length&&"0"===i[0].getAttribute("key"))await firebase.database().ref(`images/${this._value}`).remove();else{if(await firebase.database().ref(`images/${this._value}/${t}`).remove(),"0"===t){await firebase.database().ref(`images/${this._value}/thumb`).remove(),await firebase.database().ref(`images/${this._value}/thumbm`).remove(),await firebase.database().ref(`images/${this._value}/placeholder`).remove();const e=(i=Array.from(this.nails.querySelectorAll("img")))[0].src.replace("https://guldentopveldwinkel.be/ipfs/","");94!==e.length&&(await this.addImage(this._value,0,e,960,95),await this.addImage(this._value,"thumbm",e,320,95),await this.addImage(this._value,"thumb",e,120,85),await this.addImage(this._value,"placeholder",e,5,25));const t=(new Date).getTime();await firebase.database().ref(`images/${this._value}/${t}`).set(t)}await firebase.database().ref(`images/${this._value}/${t}`).remove()}this.saving=!1}async _onNailUpload({detail:e}){this.saving=!0;const t=this.nails.children.length>0?this.nails.children.length-1:0;console.log(t),0===t&&(await this.addImage(this._value,"thumbm",e,320,95),await this.addImage(this._value,"thumb",e,120,85),await this.addImage(this._value,"placeholder",e,5,25)),await this.addImage(this._value,t,e,960,95),this.nails.add({src:e,key:t}),this.saving=!1}async _onPublic(){this.publicIcon.hasAttribute("public")?this.publicIcon.removeAttribute("public"):this.publicIcon.setAttribute("public",""),await firebase.database().ref(`offerDisplay/${this._value}/public`).set(this.publicIcon.hasAttribute("public")),globalThis.pubsub.publish(`event.${this.ref}`,{type:"public",key:this._value,value:this.publicIcon.hasAttribute("public")}),history.back()}async _onDelete(){await confirm("are you sure you want to remove this product?")&&(console.log(`${this.ref}/${this._value}`),firebase.database().ref(`${this.ref}/${this._value}`).remove(),"offers"===this.ref&&(firebase.database().ref(`offerDisplay/${this._value}`).remove(),firebase.database().ref(`images/${this._value}`).remove()),history.back(),globalThis.pubsub.publish(`event.${this.ref}`,{type:"delete",key:this._value}))}}export{ProductEditorMixin as P};
